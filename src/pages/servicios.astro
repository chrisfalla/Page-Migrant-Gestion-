---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import ServiceCardSmall from '../components/ServiceCardSmall.astro';
import ServiceModal from '../components/ServiceModal.astro';
import { services } from '../data/services';
import type { Service } from '../data/services';
---

<Layout title="Todos Nuestros Servicios | Migrant GestiÃ³n">
  <Header />
  <main class="services-page">
    <!-- Simple Header -->
    <section class="services-header">
      <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb" aria-label="NavegaciÃ³n de ruta">
          <a href="/" class="breadcrumb-link">Inicio</a>
          <span class="breadcrumb-separator">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </span>
          <span class="breadcrumb-current">Servicios</span>
        </nav>

        <!-- Page Title -->
        <div class="page-title-wrapper reveal">
          <h1 class="page-title">CatÃ¡logo de Servicios</h1>
          <p class="page-description">
            Explora nuestra oferta completa de trÃ¡mites migratorios y legales. 
            <strong>{services.length} servicios</strong> disponibles con asesorÃ­a personalizada.
          </p>
        </div>

        <!-- Category Pills -->
        <div class="category-pills reveal">
          <button class="pill pill-active" data-category="all">
            Todos ({services.length})
          </button>
          <button class="pill" data-category="visas">
            ðŸ›‚ Visas
          </button>
          <button class="pill" data-category="documentos">
            ðŸ“„ Documentos
          </button>
          <button class="pill" data-category="legalizacion">
            âœ… Legalizaciones
          </button>
          <button class="pill" data-category="otros">
            ðŸ“‹ Otros trÃ¡mites
          </button>
        </div>
      </div>
    </section>

    <!-- Services Grid -->
    <section class="services-grid-section">
      <div class="container">
        <div class="services-grid" id="services-grid">
          {services.map((service: Service) => (
            <div class="reveal service-item">
              <ServiceCardSmall service={service} />
            </div>
          ))}
        </div>
      </div>
    </section>

    <!-- CTA Section -->
    <section class="services-cta reveal">
      <div class="container">
        <div class="cta-card">
          <div class="cta-content">
            <h2 class="cta-title">Â¿No encuentras lo que buscas?</h2>
            <p class="cta-description">
              ContÃ¡ctanos y te ayudaremos con tu caso particular. Nuestro equipo estÃ¡ listo para asesorarte.
            </p>
          </div>
          <a href="#contacto" class="cta-button">
            Consultar ahora
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="5" y1="12" x2="19" y2="12"></line>
              <polyline points="12 5 19 12 12 19"></polyline>
            </svg>
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Component -->
  <ServiceModal />
  
  <!-- Footer -->
  <Footer />
</Layout>

<style>
  /* ============================================
     Main Layout - Using Global Variables
     ============================================ */
  .services-page {
    min-height: 100vh;
    background: var(--color-white);
  }

  .container {
    max-width: var(--container-xl);
    margin: 0 auto;
    padding: 0 var(--space-6);
  }

  /* ============================================
     Simple Header
     ============================================ */
  .services-header {
    padding: var(--space-4) 0 var(--space-8);
    background: var(--color-white);
    border-bottom: 1px solid var(--color-gray-200);
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
  }

  .breadcrumb-link {
    color: var(--color-gray-600);
    text-decoration: none;
    font-weight: var(--font-medium);
    transition: color var(--transition-base);
  }

  .breadcrumb-link:hover {
    color: var(--color-primary);
  }

  .breadcrumb-separator {
    color: var(--color-gray-400);
    display: flex;
    align-items: center;
  }

  .breadcrumb-current {
    color: var(--color-primary);
    font-weight: var(--font-semibold);
  }

  /* Page Title */
  .page-title-wrapper {
    margin-bottom: var(--space-6);
  }

  .page-title {
    font-family: var(--font-display);
    font-size: clamp(var(--text-3xl), 4vw, var(--text-5xl));
    font-weight: var(--font-extrabold);
    color: var(--color-primary);
    margin: 0 0 var(--space-3) 0;
    line-height: var(--leading-tight);
    letter-spacing: -0.02em;
  }

  .page-description {
    font-size: var(--text-base);
    line-height: var(--leading-relaxed);
    color: var(--color-gray-600);
    max-width: 700px;
    margin: 0;
  }

  .page-description strong {
    color: var(--color-accent);
    font-weight: var(--font-bold);
  }

  /* Category Pills */
  .category-pills {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
  }

  .pill {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-4);
    background: var(--color-white);
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-full);
    color: var(--color-gray-700);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-base);
    white-space: nowrap;
  }

  .pill:hover {
    background: var(--color-gray-50);
    border-color: var(--color-accent);
    color: var(--color-primary);
    transform: translateY(-2px);
  }

  .pill-active {
    background: var(--color-accent);
    border-color: var(--color-accent);
    color: var(--color-white);
    box-shadow: var(--shadow-sm);
  }

  .pill-active:hover {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-white);
    transform: translateY(-2px);
  }

  /* ============================================
     Services Grid Section
     ============================================ */
  .services-grid-section {
    padding: var(--space-8) 0 var(--space-16);
    background: var(--color-gray-50);
  }

  .services-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-6);
  }

  @media (min-width: 768px) {
    .services-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .services-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-8);
    }
  }

  @media (min-width: 1280px) {
    .services-grid {
      grid-template-columns: repeat(5, 1fr);
    }
  }

  /* ============================================
     CTA Section
     ============================================ */
  .services-cta {
    padding: var(--space-16) 0 var(--space-24);
    background: var(--color-white);
  }

  .cta-card {
    background: linear-gradient(135deg, var(--color-primary) 0%, #1e3a5f 50%, #0a2a5a 100%);
    border-radius: var(--radius-2xl);
    padding: var(--space-12) var(--space-10);
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: var(--space-8);
    box-shadow: var(--shadow-primary);
    position: relative;
    overflow: hidden;
  }

  .cta-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--color-accent) 0%, #60a5fa 50%, var(--color-accent) 100%);
  }

  @media (min-width: 768px) {
    .cta-card {
      flex-direction: row;
      text-align: left;
      padding: var(--space-12) var(--space-16);
    }
  }

  .cta-content {
    flex: 1;
  }

  .cta-title {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: var(--font-extrabold);
    color: var(--color-white);
    margin: 0 0 var(--space-4) 0;
    line-height: var(--leading-tight);
  }

  .cta-description {
    font-size: var(--text-lg);
    line-height: var(--leading-relaxed);
    color: #cbd5e1;
    margin: 0;
  }

  .cta-button {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-5) var(--space-10);
    background: var(--color-white);
    color: var(--color-primary);
    font-family: var(--font-display);
    font-weight: var(--font-bold);
    font-size: var(--text-lg);
    text-decoration: none;
    border-radius: var(--radius-xl);
    transition: all var(--transition-slow);
    white-space: nowrap;
    flex-shrink: 0;
    box-shadow: var(--shadow-md);
  }

  .cta-button:hover {
    background: var(--color-accent);
    color: var(--color-white);
    transform: translateY(-3px);
    box-shadow: var(--shadow-xl);
  }

  .cta-button svg {
    transition: transform var(--transition-slow);
  }

  .cta-button:hover svg {
    transform: translateX(5px);
  }

  /* ============================================
     Reveal Animation
     ============================================ */
  .reveal {
    opacity: 0;
    transform: translateY(30px);
    transition: all var(--transition-slower) var(--ease-out-expo);
  }

  .reveal.active {
    opacity: 1;
    transform: translateY(0);
  }

  /* Staggered animation delays */
  .service-item:nth-child(n+1):nth-child(-n+5) { transition-delay: calc(var(--transition-fast) * var(--nth)); }
  .service-item:nth-child(1) { --nth: 1; }
  .service-item:nth-child(2) { --nth: 2; }
  .service-item:nth-child(3) { --nth: 3; }
  .service-item:nth-child(4) { --nth: 4; }
  .service-item:nth-child(5) { --nth: 5; }

  /* ============================================
     Responsive
     ============================================ */
  @media (max-width: 768px) {
    .services-header {
      padding: var(--space-3) 0 var(--space-6);
    }

    .breadcrumb {
      margin-bottom: var(--space-3);
      font-size: var(--text-xs);
    }

    .page-title-wrapper {
      margin-bottom: var(--space-4);
    }

    .page-title {
      font-size: var(--text-2xl);
      margin-bottom: var(--space-2);
    }

    .page-description {
      font-size: var(--text-sm);
    }

    .category-pills {
      gap: var(--space-2);
    }

    .pill {
      padding: var(--space-2) var(--space-3);
      font-size: var(--text-xs);
    }

    .services-grid-section {
      padding: var(--space-6) 0 var(--space-12);
    }

    .services-grid {
      gap: var(--space-5);
    }

    .services-cta {
      padding: var(--space-10) 0 var(--space-16);
    }

    .cta-card {
      padding: var(--space-10) var(--space-6);
    }

    .cta-title {
      font-size: var(--text-2xl);
    }

    .cta-description {
      font-size: var(--text-base);
    }

    .cta-button {
      padding: var(--space-4) var(--space-8);
      font-size: var(--text-base);
    }
  }
</style>

<script>
  const initServiciosPage = () => {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;
          entry.target.classList.add('active');
          observer.unobserve(entry.target);
        });
      },
      {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px',
      }
    );

    document.querySelectorAll('.reveal').forEach((el) => {
      observer.observe(el);
    });

    const categoryPills = document.querySelectorAll('.pill');
    const serviceItems = document.querySelectorAll('.service-item');

    const categoryKeywords = {
      visas: ['visa', 'migratoria', 'residencia', 'temporal', 'extranjeria'],
      documentos: ['pasaporte', 'cedula', 'documento', 'apostilla', 'certificado', 'antecedentes'],
      legalizacion: ['legalizacion', 'convalidacion', 'homologacion', 'reconocimiento', 'titulo'],
    };

    const matchesCategory = (serviceTitle, category) => {
      if (category === 'all') return true;
      const keywords = categoryKeywords[category];
      if (!keywords) return false;
      const titleLower = serviceTitle
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '');
      return keywords.some((keyword) => titleLower.includes(keyword));
    };

    categoryPills.forEach((pill) => {
      pill.addEventListener('click', () => {
        categoryPills.forEach((p) => p.classList.remove('pill-active'));
        pill.classList.add('pill-active');

        const category = pill.getAttribute('data-category') || 'all';

        serviceItems.forEach((item, index) => {
          const title = item.querySelector('.card-title')?.textContent?.trim() || '';
          const matches = matchesCategory(title, category);

          if (matches) {
            setTimeout(() => {
              item.style.display = 'block';
              requestAnimationFrame(() => item.classList.add('active'));
            }, index * 30);
            return;
          }

          item.classList.remove('active');
          setTimeout(() => {
            item.style.display = 'none';
          }, 300);
        });
      });
    });

    let servicesCache = null;
    const loadServices = async () => {
      if (servicesCache) return servicesCache;
      const module = await import('../data/services');
      servicesCache = module.services;
      return servicesCache;
    };

    const servicesGrid = document.getElementById('services-grid');

    const openModalFromCard = async (card) => {
      if (!card) return;
      const serviceId = card.getAttribute('data-service-id');
      if (!serviceId) return;
      const servicesData = await loadServices();
      const service = servicesData.find((s) => s.id === serviceId);
      if (service && window.showServiceModal) {
        window.showServiceModal(service);
      }
    };

    servicesGrid?.addEventListener('click', async (e) => {
      const card = e.target.closest('[data-service-id]');
      await openModalFromCard(card);
    });

    servicesGrid?.addEventListener('keydown', async (e) => {
      if (e.key !== 'Enter' && e.key !== ' ') return;
      const card = e.target.closest('[data-service-id]');
      if (!card) return;
      e.preventDefault();
      await openModalFromCard(card);
    });
  };

  if ('requestIdleCallback' in window) {
    requestIdleCallback(initServiciosPage, { timeout: 2500 });
  } else {
    setTimeout(initServiciosPage, 200);
  }
</script>
